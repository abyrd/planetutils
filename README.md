[![current release version](https://img.shields.io/github/release/interline-io/planetutils.svg)](https://github.com/interline-io/planetutils/releases)
[![Docker Hub container image build status](https://img.shields.io/docker/build/interline/planetutils.svg)](https://hub.docker.com/r/interline/planetutils/)
[![CircleCI code test status](https://circleci.com/gh/interline-io/planetutils.svg?style=svg)](https://circleci.com/gh/interline-io/planetutils)

# Interline PlanetUtils

<!-- the following is generated by:
     1. npm install --save markdown-toc -g
     2. markdown-toc -i README.md
-->

<!-- toc -->

- [Features](#features)
- [Installation](#installation)
  * [Using Docker container](#using-docker-container)
  * [Using Homebrew on Mac OS](#using-homebrew-on-mac-os)
  * [Using Python package](#using-python-package)
- [Usage](#usage)
  * [osm_planet_update](#osm_planet_update)
  * [osm_planet_extract](#osm_planet_extract)
  * [elevation_tile_download](#elevation_tile_download)
  * [Bounding box CSV file format](#bounding-box-csv-file-format)
- [Support](#support)

<!-- tocstop -->

## Features

Python-based scripts and a Docker container to work with planet-scale geographic data. Using PlanetUtils, you can:

- maintain your own copy of the [OpenStreetMap](http://www.openstreetmap.org) planet (by applying incremental updates)
- cut your copy of the OSM planet into named bounding boxes (a.k.a., mini Mapzen Metro Extracts)
- download [Mapzen Terrain Tiles from AWS](https://aws.amazon.com/public-datasets/terrain/) for the planet or your bounding boxes
- download [Valhalla Tilepacks from Interline](https://www.interline.io/valhalla/tilepacks/)

PlanetUtils is packaged for use as a:

- Docker container, for use on any operating system
- Python package, for use on any operating system
- Homebrew formula, for use on Mac OS

## Installation

### Using Docker container

Make sure you have [Docker](https://www.docker.com/community-edition) installed. Then:

```sh
docker pull interline/planetutils:release-v0.2.4
```

Any of the example commands below can be executed with `docker run`. It may be helpful to mount a local directory inside the container for persistence and to access output files.

- Example of using `docker run` with the `data` directory mounted as `/data`:

```sh
docker run --rm -v ${PWD}/data:/data -t interline/planetutils:release-v0.2.4 <command>
```

### Using Homebrew on Mac OS

Make sure you have [Homebrew](https://brew.sh/) installed. Then:

```sh
brew install interline-io/planetutils/planetutils
```

### Using Python package

If you want to install and use the Python package directly, you'll need to provide:

- Python 2.x
- Java
- [Osmosis](https://wiki.openstreetmap.org/wiki/Osmosis)
- [OSM C tools](https://gitlab.com/osm-c-tools/osmctools/)

Then clone this repo, run the tests, and install the Python package:

```sh
git clone https://github.com/interline-io/planetutils.git
python ./setup.py test
pip install .
```

## Usage

PlanetUtils supplies the following command-line utilities:

### osm_planet_update

Update a local OSM planet. For example:

```sh
osm_planet_update planet-recent.osm.pbf planet-with-updates.osm.pbf
```

If `planet-recent.osm.pbf` does not exist locally, the most recent planet file will be downloaded, before applying hourly updates to it. (Note: This download is nearly 40Gb.) By default, files are downloaded from planet.openstreetmap.org. Amazon Web Services also provides [OSM planets through its Public Datasets program](https://aws.amazon.com/public-datasets/osm/). To instead download the planet file from AWS:

1. Make sure you have your [AWS credentials configured locally](http://boto3.readthedocs.io/en/latest/guide/configuration.html).
2. Append the `--s3` flag.

Note that an entire OSM planet may be upwards of 40Gb in size! In other words, you should have ~80Gb free disk space before running this command.

For complete help on command-line arguments:

```sh
osm_planet_update -h
```

### osm_planet_extract

Cut up an OSM planet file into one or more extracts, defined by bounding boxes. Each bounding box is assigned a name. (This is like a mini version of Mapzen Metro Extracts!)

To create a single extract:

```sh
osm_planet_extract --outpath=data/osm_extracts --bbox=-122.737,37.449,-122.011,37.955 --name=san-francisco planet-latest.osm.pbf
```

To specify more than one bounding box of tiles to download, list the bounding boxes in a [CSV file](#bounding-box). For example:

```sh
osm_planet_extract --outpath=data/osm_extracts --csv=data/bboxes.csv planet-latest.osm.pbf
```

For complete help on command-line arguments:

```sh
osm_planet_extract -h
```

### elevation_tile_download

Download elevation tiles from the [Terrain Tiles in the AWS Public Datasets program](https://aws.amazon.com/public-datasets/terrain/). Download for the entire planet, only tiles within a single bounding box, or within multiple bounding boxes.

To download the entire planet of tiles (__which will require about 1.6Tb of space!__):

```sh
elevation_tile_download --outpath=data/elevation
```

To download tiles to cover a single bounding box:

```sh
elevation_tile_download --outpath=data/elevation --bbox=-122.737,37.449,-122.011,37.955
```

To specify more than one bounding box of tiles to download, list the bounding boxes in a [CSV file](#bounding-box). For example:

```sh
elevation_tile_download --outpath=data/elevation --csv=data/bboxes.csv
```

For complete help on command-line arguments:

```sh
elevation_tile_download -h
```

<a name="valhalla-tilepacks"></a>

### valhalla_tilepack_download

Download [Valhalla Tilepacks from Interline](https://www.interline.io/valhalla/tilepacks/) to power your own instances of the [Valhalla routing engine](https://www.interline.io/valhalla/).

Initial set-up:

1. Sign up for [Valhalla Tilepacks from Interline](https://www.interline.io/valhalla/tilepacks/).
2. Place your key file at `~/.interline-planetutils/valhalla-tilepacks-key.json`

Download planet-wide Tilepacks:

TODO


### Bounding box CSV file format
<a name="bounding-box"></a>

When extracting multiple bounding boxes from an OSM planet, or when downloading multiple bounding boxes of elevation tiles, you can specify your bounding boxes in a single CSV file. Do not include a header row. The format is as follows:

```csv
[name for extract],[left longitude],[bottom latitude],[right longitude],[top latitude]
```

For example:
```csv
san-francisco,-122.737,37.449,-122.011,37.955
dar-es-salaam,38.894,-7.120,39.661,-6.502
```

To determine a bounding box, try the tool at http://bboxfinder.com/

## Support

To report a bug, please [open an issue](https://github.com/interline-io/planetutils).

Interline Technologies also provides professional support and consulting services around this and other related tools. Contact us at info@interline.io for more information.
